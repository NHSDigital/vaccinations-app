server {
    listen 9123;
    server_name _;

    root /usr/share/nginx/html;

    sub_filter_types application/json;

    set $login_root_url "${LOGIN_ROOT_URL}";

    location /eligibility-signposting-api/patient-check/ {
        access_by_lua_block { ngx.sleep(${ELID_DELAY_SECONDS}) }

        rewrite ^/eligibility-signposting-api/patient-check/(.*)$ /data/elid/$1.json break;
        add_header Content-Type application/json;
    }

    location /oauth2/ {
        access_by_lua_block { ngx.sleep(${APIM_DELAY_SECONDS}) }

        rewrite ^/oauth2/(.*)$ /data/apim/$1.json break;
        add_header Content-Type application/json;
        error_page  405 =200 $uri;
    }

    location = /.well-known/openid-configuration {
        sub_filter '@@LOGIN_ROOT_URL@@' $login_root_url;
        sub_filter_once off;

        rewrite ^ /data/login/openid-configuration.json break;
        add_header Content-Type application/json;
    }


    location = /.well-known/jwks.json {
        rewrite ^ /data/login/jwks.json break;
        add_header Content-Type application/json;
    }

    location = /authorize {
        return 302 'https://localhost:3000/api/auth/callback/nhs-login?code=2345&$args';
    }

    location = /token {
        if ($request_method != POST) {
            return 405;
        }

        content_by_lua_block {
            local token_dir = "/usr/share/nginx/html/data/login/tokens"

            local command = "find " .. token_dir .. " -name '*.json' -type f"
            local handle = io.popen(command)

            if not handle then
                ngx.log(ngx.ERR, "could not execute command: ", command)
                return ngx.exit(500)
            end

            local files = {}
            for file_path in handle:lines() do
                table.insert(files, file_path)
            end
            handle:close()

            if #files == 0 then
                ngx.log(ngx.ERR, "no .json files found in directory: ", token_dir)
                return ngx.exit(404)
            end

            local random_file_path = files[math.random(#files)]

            local file = io.open(random_file_path, "r")
            if not file then
                ngx.log(ngx.ERR, "could not open file: ", random_file_path)
                return ngx.exit(500)
            end

            local content = file:read("*a")
            file:close()

            ngx.header["Content-Type"] = "application/json"
            ngx.print(content)
        }
    }

    location = /userinfo {
        rewrite ^ /data/login/userinfo.json break;
        add_header Content-Type application/json;
    }

    location /health {
        return 200 "healthy";
        add_header Content-Type text/plain;
    }
}
