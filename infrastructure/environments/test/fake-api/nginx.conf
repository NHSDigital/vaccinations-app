server {
    listen 9123;
    server_name _;

    root /usr/share/nginx/html;

    sub_filter_types application/json;

    set $login_root_url "${LOGIN_ROOT_URL}";

    location /eligibility-signposting-api/patient-check/ {
        access_by_lua_block { ngx.sleep(${ELID_DELAY_SECONDS}) }

        rewrite ^/eligibility-signposting-api/patient-check/(.*)$ /data/elid/$1.json break;
        add_header Content-Type application/json;
    }

    location /oauth2/ {
        access_by_lua_block { ngx.sleep(${APIM_DELAY_SECONDS}) }

        rewrite ^/oauth2/(.*)$ /data/apim/$1.json break;
        add_header Content-Type application/json;
        error_page  405 =200 $uri;
    }

    location = /.well-known/openid-configuration {
        sub_filter '@@LOGIN_ROOT_URL@@' $login_root_url;
        sub_filter_once off;

        rewrite ^ /data/login/openid-configuration.json break;
        add_header Content-Type application/json;
    }


    location = /.well-known/jwks.json {
        rewrite ^ /data/login/jwks.json break;
        add_header Content-Type application/json;
    }

    location = /authorize {
        return 302 'https://localhost:3000/api/auth/callback/nhs-login?code=2345&$args';
    }

    location = /token {
        if ($request_method != POST) {
            return 405;
        }

        content_by_lua_block {
            local root_path = "/usr/share/nginx/html"

            local files = {
                "/data/login/tokens/9436793375.json",
                "/data/login/tokens/9450114080.json",
                "/data/login/tokens/9451019030.json"
            }

            local random_file_uri = files[math.random(#files)]
            local full_file_path = root_path .. random_file_uri

            local file = io.open(full_file_path, "r")
            if not file then
                ngx.log(ngx.ERR, "could not open file: ", full_file_path)
                return ngx.exit(500)
            end

            local content = file:read("*a")
            file:close()

            ngx.header["Content-Type"] = "application/json"
            ngx.print(content)
        }
    }

    location = /userinfo {
        rewrite ^ /data/login/userinfo.json break;
        add_header Content-Type application/json;
    }

    location /health {
        return 200 "healthy";
        add_header Content-Type text/plain;
    }
}
