server {
    listen 9123;
    server_name _;

    root /usr/share/nginx/html;

    sub_filter_types application/json;

    set $login_root_url "${LOGIN_ROOT_URL}";
    set $app_root_url "${APP_ROOT_URL}";
    set $nbs_url "${NBS_URL}";

    location /eligibility-signposting-api/patient-check/ {
        access_by_lua_block { ngx.sleep(${ELID_DELAY_SECONDS}) }

        sub_filter '@@NBS_URL@@' $nbs_url;
        sub_filter_once off;

        rewrite ^/eligibility-signposting-api/patient-check/(.*)$ /data/elid/$1.json break;
        add_header Content-Type application/json;
    }

    location /oauth2/ {
        access_by_lua_block { ngx.sleep(${APIM_DELAY_SECONDS}) }

        rewrite ^/oauth2/(.*)$ /data/apim/$1.json break;
        add_header Content-Type application/json;
        error_page  405 =200 $uri;
    }

    location = /.well-known/openid-configuration {
        sub_filter '@@LOGIN_ROOT_URL@@' $login_root_url;
        sub_filter_once off;

        rewrite ^ /data/login/openid-configuration.json break;
        add_header Content-Type application/json;
    }

    location = /.well-known/jwks.json {
        rewrite ^ /data/login/jwks.json break;
        add_header Content-Type application/json;
    }

    location = /authorize {
        return 302 '$app_root_url/api/auth/callback/nhs-login?code=2345&$args';
    }

    location /token {
        proxy_pass http://127.0.0.1:5000;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location = /userinfo {
        rewrite ^ /data/login/userinfo.json break;
        add_header Content-Type application/json;
    }

    location /nbs {
        return 200 "booking";
        add_header Content-Type text/plain;
    }

    location /health {
        return 200 "healthy";
        add_header Content-Type text/plain;
    }
}
